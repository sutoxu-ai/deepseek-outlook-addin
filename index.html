<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DeepSeek 助手</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/Office.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
    .container { max-width: 600px; margin: auto; }
    h1 { color: #0078d4; }
    .status { color: #0078d4; margin: 10px 0; }
    .summary { white-space: pre-wrap; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>DeepSeek 助手</h1>
    <div id="status" class="status">正在初始化...</div>
    <div id="summary" class="summary"></div>
  </div>

  <script>
    // 检查是否在 Office 环境中
    if (typeof Office === 'undefined') {
      document.getElementById('status').innerText = "✅ 测试成功！";
      document.getElementById('summary').innerText = "此页面仅用于 Outlook 插件测试。";
      return;
    }

    // Office 环境下正常运行
    Office.onReady(() => {
      const status = document.getElementById('status');
      const summary = document.getElementById('summary');

      // 获取邮件内容
      const item = Office.context.mailbox.item;
      if (!item || !item.body) {
        status.innerText = "⚠️ 无法读取邮件内容";
        return;
      }

      status.innerText = "正在生成摘要...";
      item.body.getAsync("text", (result) => {
        if (result.status !== Office.AsyncResultStatus.Succeeded) {
          summary.innerText = "❌ 读取失败: " + result.error.message;
          return;
        }

        const subject = item.subject || "无主题";
        const body = result.value || "";

        fetch("https://deepseek-proxy-seven.vercel.app/api/ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ subject, body })
        })
        .then(res => res.json())
        .then(data => {
          status.innerText = "✅ 摘要生成完成";
          summary.innerText = data.summary || "生成失败";
        })
        .catch(err => {
          status.innerText = "❌ 网络错误";
          summary.innerText = err.message;
        });
      });
    });
  </script>
</body>
</html>
