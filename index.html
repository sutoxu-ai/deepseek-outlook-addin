
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>DeepSeek 智能回复助手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Arial; margin:20px;}
    h2{margin-top:0}
    textarea{width:100%; min-height:100px;}
    button{margin-right:8px; padding:8px 12px}
    pre{white-space:pre-wrap; background:#f6f8fa; padding:12px; border:1px solid #e1e4e8;}
    .tip{color:#555; font-size:0.9em}
  </style>
</head>
<body>
  <h2>DeepSeek 智能回复助手</h2>
  <p class="tip">在下方输入你的回复要求（例如：语气礼貌、简洁、字数 120-150），点击“生成回复”，再点击“插入到邮件”。</p>

  <label>回复要求：</label>
  <textarea id="extra" placeholder="例如：语气礼貌、条理清晰，包含三点回应。"></textarea>
  <div style="margin:10px 0;">
    <button id="btnSuggest">生成回复</button>
    <button id="btnInsert">插入到邮件</button>
  </div>
  <h3>建议回复</h3>
  <pre id="suggestion"></pre>

  <script>
    Office.onReady(() => {
      const suggestBtn = document.getElementById('btnSuggest');
      const insertBtn = document.getElementById('btnInsert');

      suggestBtn.addEventListener('click', async () => {
        try {
          const extra = document.getElementById('extra').value || '语气专业且礼貌，简洁明了';
          const prompt = `你是一名中文商务邮件助手。请根据以下要求生成一封可直接发送的中文回复邮件正文：${extra}`;

          // TODO: 将你的 DeepSeek API Key 安全地放在后端代理；仅用于本地测试可直接写在此处
          const apiKey = 'REPLACE_WITH_YOUR_DEEPSEEK_API_KEY';

          const resp = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'deepseek-chat',
              messages: [
                { role: 'system', content: 'You are a helpful email assistant that writes in Chinese.' },
                { role: 'user', content: prompt }
              ],
              temperature: 0.7
            })
          });

          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('DeepSeek API 返回错误：' + txt);
          }
          const data = await resp.json();
          const suggestion = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
          window.lastSuggestion = suggestion.trim();
          document.getElementById('suggestion').textContent = window.lastSuggestion || '（未生成内容）';
        } catch (e) {
          alert('生成失败：' + (e.message || e));
          console.error(e);
        }
      });

      insertBtn.addEventListener('click', async () => {
        try {
          if (!window.lastSuggestion) {
            alert('请先生成回复');
            return;
          }
          Office.context.mailbox.item.body.setAsync(window.lastSuggestion, {
            coercionType: Office.CoercionType.Text,
            insertLocation: 'end'
          }, result => {
            if (result.status !== Office.AsyncResultStatus.Succeeded) {
              alert('插入失败：' + (result.error && result.error.message));
            } else {
              alert('已插入到草稿');
            }
          });
        } catch (e) {
          alert('插入失败：' + (e.message || e));
          console.error(e);
        }
      });
    });
  </script>
</body>
</html>
